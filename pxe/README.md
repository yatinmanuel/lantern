# PXE Files

This directory is mounted into containers at `/var/www/html` and is used for
both HTTP (backend) and TFTP (dnsmasq) file serving.

Expected layout:
- `ipxe/` - iPXE boot files (e.g. `undionly.kpxe`, `ipxe.efi`) and `menu.ipxe`
- `os-files/` - cached OS artifacts downloaded by the backend
- `iso/` - ISO images for traditional PXE workflows

Notes:
- `menu.ipxe` is generated by the API (`POST /api/config/ipxe/regenerate`).
- Place iPXE binaries in `ipxe/` so the TFTP server can serve them.
- `dnsmasq.conf` may be generated by the API (`POST /api/config/service/dnsmasq/regenerate`)
  and consumed by the dnsmasq container.

### Ubuntu live server netboot (special case)

**Recommended: NFS Container (default)**

The stack includes an NFS container (`nfs` service) that automatically exports `/var/www/html/iso` for Ubuntu netboot. This is the default and recommended approach.

To use:
1. Start the stack with `docker compose up` — the NFS container starts automatically.
2. Import/extract an Ubuntu ISO via the UI or API.
3. Boot arguments are generated as `nfsroot=SERVER:/var/www/html/iso/<iso-name>`.

Configuration (Settings → PXE Config):
- **NFS Export Subnet**: The subnet allowed to mount NFS (default: `192.168.1.0/24`). Restart the NFS container after changing.
- **NFS Export Path**: Leave empty for the NFS container (default). Only set if running NFS on the host.
- **Ubuntu Netboot Mode**: `NFS` (default) or `HTTP` (fragile Path A).

To update existing images after changing config, open the image in Images and click **Regenerate** next to Boot Arguments.

**Alternative: Host NFS**

If you prefer running NFS on the host instead of the container:
1. Stop or remove the `nfs` container.
2. Set **NFS Export Path** in Settings to your host path (e.g. `/home/pxe/pixie/pxe/iso`).
3. Configure `/etc/exports` on the host:
   ```
   /home/pxe/pixie/pxe/iso 192.168.1.0/24(ro,no_subtree_check,no_root_squash)
   ```
4. Run `exportfs -ra` and ensure `rpcbind` and `nfs-server` are running.

**Path A: HTTP + fetch= (supported but fragile)**

Ubuntu casper supports HTTP netboot with `fetch=filesystem.squashfs`. It is poorly documented and sensitive to DHCP and boot-args. To try it:

1. **DHCP Option 66 (next-server)** — Must be the PXE server IP so casper's initrd DHCP gets it. The generated dnsmasq config includes `dhcp-option=66,<pxe_server_ip>`. If DHCP is elsewhere (e.g. **pfSense**): Services → DHCP Server → [edit your LAN scope] → at bottom add **Option 66 (Next Server)** = `192.168.1.10` (your PXE host), save.
2. **Correct squashfs** — Generator uses `filesystem.squashfs` or `filesystem.squashfs.lz` under `/casper/`; no other filename.
3. **Unquoted kernel args** — Generated args are unquoted. If you edit manually, avoid quotes and truncation.
4. **Opt-in** — Set **Ubuntu Netboot Mode** to `HTTP` in Settings → PXE Config, or via API.
5. **Verify** — In initramfs run `cat /proc/cmdline` and confirm `fetch=` is present; casper should not try CIFS/NFS first.

If Path A boots once, treat it as proven; use NFS for day-to-day Ubuntu. Alpine/Debian remain HTTP-first.
