services:
  nats:
    container_name: lantern-nats
    image: nats:2
    command: ["-js", "-sd", "/data", "-m", "8222"]
    restart: unless-stopped
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats-data:/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  dnsmasq:
    container_name: lantern-dnsmasq
    build:
      context: ./dnsmasq
      dockerfile: Dockerfile
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    environment:
      DHCP_INTERFACE: ${DHCP_INTERFACE:-ens18}
      DHCP_MODE: ${DHCP_MODE:-proxy}
      DHCP_PROXY_SUBNET: ${DHCP_PROXY_SUBNET:-192.168.1.0}
      DHCP_PROXY_NETMASK: ${DHCP_PROXY_NETMASK:-255.255.255.0}
      DHCP_RANGE: ${DHCP_RANGE:-192.168.1.100,192.168.1.200,12h}
      PXE_SERVER_IP: ${PXE_SERVER_IP:-192.168.1.10}
      PXE_SERVER_PORT: ${PXE_SERVER_PORT:-3000}
      TFTP_ROOT: /var/www/html
      DNSMASQ_CONFIG_PATH: /var/www/html/dnsmasq.conf
      IPXE_BASE_URL: ${IPXE_BASE_URL:-https://boot.ipxe.org}
      WIMBOOT_URL: ${WIMBOOT_URL:-https://boot.ipxe.org/wimboot}
      DNSMASQ_PORT: ${DNSMASQ_PORT:-0}
      DNSMASQ_LOG_DHCP: ${DNSMASQ_LOG_DHCP:-0}
      DNSMASQ_LOG_QUERIES: ${DNSMASQ_LOG_QUERIES:-0}
    volumes:
      - ./pxe:/var/www/html
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    container_name: lantern-backend
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: 3000
      NATS_URL: nats://nats:4222
      DATABASE_PATH: /app/data/pxe.db
      OS_FILES_DIR: /var/www/html/os-files
      DNSMASQ_CONFIG_PATH: /var/www/html/dnsmasq.conf
      PXE_SERVER_IP: ${PXE_SERVER_IP:-192.168.1.10}
      PXE_SERVER_URL: ${PXE_SERVER_URL:-http://localhost:3000}
      PXE_SERVER_PORT: ${PXE_SERVER_PORT:-3000}
      DHCP_INTERFACE: ${DHCP_INTERFACE:-ens18}
      DHCP_RANGE: ${DHCP_RANGE:-192.168.1.100,192.168.1.200,12h}
      WEB_ROOT: /var/www/html
      IPXE_MENU_PATH: /var/www/html/ipxe/menu.ipxe
      ISO_DIR: /var/www/html/iso
      ISO_MAX_SIZE_MB: ${ISO_MAX_SIZE_MB:-8192}
      ALPINE_VERSION: ${ALPINE_VERSION:-latest-stable}
      ALPINE_MIRROR: ${ALPINE_MIRROR:-https://dl-cdn.alpinelinux.org/alpine}
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - backend-data:/app/data
      - ./pxe:/var/www/html
    depends_on:
      - nats
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/health',res=>process.exit(res.statusCode===200?0:1)).on('error',()=>process.exit(1));\""]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  web:
    container_name: lantern-web
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3000}
    environment:
      NODE_ENV: production
      PORT: 3001
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3000}
    restart: unless-stopped
    ports:
      - "3001:3001"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3001',res=>process.exit(res.statusCode===200?0:1)).on('error',()=>process.exit(1));\""]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  nats-data:
  backend-data:
